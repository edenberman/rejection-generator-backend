# main.py
from flask import Flask, request, jsonify
from flask_cors import CORS
from anthropic import Anthropic
import os
import json
from datetime import datetime
import resend
import urllib.parse

app = Flask(__name__)
CORS(app)

# API clients
client = Anthropic(api_key=os.environ.get("ANTHROPIC_API_KEY"))
resend.api_key = os.environ.get("RESEND_API_KEY")

# Counter file logic
COUNTER_FILE = 'rejection_counter.json'

def get_counter():
    try:
        with open(COUNTER_FILE, 'r') as f:
            data = json.load(f)
            return data.get('count', 0)
    except FileNotFoundError:
        return 0

def increment_counter():
    count = get_counter() + 1
    with open(COUNTER_FILE, 'w') as f:
        json.dump({'count': count, 'last_updated': datetime.now().isoformat()}, f)
    return count

def send_rejection_email(to_email, rejection_text, company, role):
    """Send the rejection letter via email with a careers link"""
    
    # Create smart link for careers page
    company_safe = urllib.parse.quote(company)
    careers_url = f"https://www.google.com/search?q={company_safe}+careers+page&btnI=1"
    
    try:
        params = {
            "from": "The Transition Project <rejections@nevoalmog.com>",
            "to": [to_email],
            "subject": f"Update regarding your application to {company}",
            "html": f"""
            <div style="font-family: 'Space Grotesk', Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 40px 20px; background-color: #1C1C1E; color: #FAF8F5;">
                <div style="background: #2C2C2E; border-left: 3px solid #D4663A; padding: 30px; margin-bottom: 30px; border-radius: 0 8px 8px 0;">
                    <p style="white-space: pre-wrap; line-height: 1.8; font-size: 15px; color: #FAF8F5;">{rejection_text}</p>
                </div>
                
                <div style="text-align: center; margin-bottom: 30px;">
                    <a href="{careers_url}" style="background-color: transparent; border: 1px solid #D4663A; color: #D4663A; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 14px; display: inline-block;">
                        See Other Roles at {company} &rarr;
                    </a>
                </div>

                <div style="border-top: 1px solid rgba(154, 149, 140, 0.3); padding-top: 20px; text-align: center;">
                    <p style="color: #9A958C; font-size: 13px; margin-bottom: 10px;">
                        This rejection letter was generated by The Transition Project
                    </p>
                    <p style="color: #9A958C; font-size: 13px;">
                        Role: {role} at {company}
                    </p>
                    <a href="https://www.nevoalmog.com" style="color: #D4663A; text-decoration: none; font-size: 13px;">
                        Learn more about The Transition Project →
                    </a>
                </div>
            </div>
            """,
            "text": f"{rejection_text}\n\n---\nCheck other roles: {careers_url}\n\nGenerated by The Transition Project"
        }
        
        email = resend.Emails.send(params)
        return True, email
    except Exception as e:
        print(f"Email error: {e}")
        return False, str(e)

@app.route('/api/counter', methods=['GET'])
def counter():
    return jsonify({'count': get_counter()})

@app.route('/api/generate', methods=['POST'])
def generate_rejection():
    try:
        data = request.json
        first_name = data.get('firstName', 'Candidate')
        last_name = data.get('lastName', '')
        company = data.get('company', 'TechCorp')
        role = data.get('role', 'Product Manager')
        email = data.get('email', None)
        
        new_count = increment_counter()
        
        prompt = f"""Generate a rejection letter from {company} for the role of {role}.
The candidate's name is {first_name} {last_name}.

STRUCTURE:

PARAGRAPH 1 - CORPORATE OPENING:
Start with a completely standard, dry corporate rejection. "Thank you for taking the time... after careful consideration... we regret to inform you..." 
Professional. Distant. Template-like.

PARAGRAPH 2 - THE BREAK (THE HEART):
The tone shifts. The recruiter breaks character. Genuinely warm and honest. 
Speak to the reader:
- A rejection letter doesn't define your worth.
- We're all just figuring it out.
- "Between you and me, none of this really matters as much as we pretend it does."
- Focus on resilience and mental health.

PARAGRAPH 3 - BACK TO CORPORATE:
Snap back to dry corporate tone. "We wish you the best in your future endeavors."

Sign off with a realistic recruiter name and title (e.g. Talent Acquisition Partner).
Do NOT include a Subject line. Start with "Dear {first_name}".
Total length: around 200 words."""

        # חזרנו לקריאה סטנדרטית ובטוחה ל-API
        message = client.messages.create(
            model="claude-3-5-sonnet-20240620",
            max_tokens=1024,
            messages=[{
                "role": "user",
                "content": prompt
            }]
        )
        
        raw_text = message.content[0].text
        
        # PYTHON CLEANUP MAGIC
        # כאן אנחנו בודקים אם יש כותרת לפני ה-"Dear" וחותכים אותה
        clean_text = raw_text
        if f"Dear {first_name}" in raw_text:
            # מוצא את האינדקס שבו מתחיל ה-Dear וחותך משם והלאה
            start_index = raw_text.find(f"Dear {first_name}")
            clean_text = raw_text[start_index:]
        elif "Dear" in raw_text:
             start_index = raw_text.find("Dear")
             clean_text = raw_text[start_index:]
        
        email_sent = False
        if email:
            email_sent, _ = send_rejection_email(email, clean_text, company, role)
        
        return jsonify({
            'success': True,
            'rejection_letter': clean_text,
            'count': new_count,
            'company': company,
            'role': role,
            'email_sent': email_sent
        })
        
    except Exception as e:
        print(f"Backend Error: {str(e)}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/health', methods=['GET'])
def health():
    return jsonify({'status': 'healthy'})

if __name__ == '__main__':
    app.run(debug=True, port=5000)
