# main.py - HAIKU ENGINE + DEEP PHILOSOPHICAL PROMPT
from flask import Flask, request, jsonify
from flask_cors import CORS
from anthropic import Anthropic
import os
import json
from datetime import datetime
import resend

app = Flask(__name__)
CORS(app)

# API clients
client = Anthropic(api_key=os.environ.get("ANTHROPIC_API_KEY"))
resend.api_key = os.environ.get("RESEND_API_KEY")

# Counter file logic
COUNTER_FILE = 'rejection_counter.json'

def get_counter():
    try:
        if not os.path.exists(COUNTER_FILE):
            return 0
        with open(COUNTER_FILE, 'r') as f:
            data = json.load(f)
            return data.get('count', 0)
    except Exception as e:
        print(f"Counter Read Error: {e}")
        return 0

def increment_counter():
    try:
        current_count = get_counter()
        new_count = current_count + 1
        with open(COUNTER_FILE, 'w') as f:
            json.dump({'count': new_count, 'last_updated': datetime.now().isoformat()}, f)
        return new_count
    except Exception as e:
        print(f"Counter Write Error: {e}")
        return get_counter() + 1

def send_rejection_email(to_email, rejection_text, company, role):
    """Send the rejection letter via email"""
    try:
        params = {
            "from": "The Transition Project <rejections@nevoalmog.com>",
            "to": [to_email],
            "subject": f"Update regarding your application to {company}",
            "html": f"""
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                <p style="white-space: pre-wrap; line-height: 1.6; color: #333;">{rejection_text}</p>
                <br>
                <hr>
                <p style="color: #888; font-size: 12px;">
                    Generated by The Transition Project<br>
                    Role: {role} at {company}
                </p>
            </div>
            """,
            "text": f"{rejection_text}\n\n---\nGenerated by The Transition Project"
        }
        
        email = resend.Emails.send(params)
        return True, email
    except Exception as e:
        print(f"Email error: {e}")
        return False, str(e)

@app.route('/api/counter', methods=['GET'])
def counter():
    return jsonify({'count': get_counter()})

@app.route('/api/generate', methods=['POST'])
def generate_rejection():
    try:
        data = request.json
        first_name = data.get('firstName', 'Candidate')
        last_name = data.get('lastName', '')
        company = data.get('company', 'TechCorp')
        role = data.get('role', 'Product Manager')
        email = data.get('email', None)
        
        new_count = increment_counter()
        
        # --- THE EXTENDED & SMART PROMPT ---
        prompt = f"""Write a rejection letter from {company} for the role of {role} to {first_name} {last_name}.

CRITICAL FORMATTING RULES:
1. Do NOT write a subject line.
2. Do NOT write the company name at the top.
3. Start strictly with "Dear {first_name},"

STRUCTURE:

PARAGRAPH 1: THE CORPORATE MASK.
Keep this brief, standard, and dry. "Thank you for applying... reviewed your qualifications... decided to move forward with other candidates." Professional and distant.

PARAGRAPH 2: THE MASK SLIPS (EXPANDED & INSIGHTFUL).
Suddenly, the tone shifts completely. The recruiter breaks the fourth wall. 
Write a substantial paragraph (approx 100-150 words) that speaks to the absurdity and difficulty of the modern career journey.
Touch on themes like:
- The invisible effort: How weird it is to spend hours optimizing a CV for an algorithm that might not even read it.
- The non-linearity of careers: How LinkedIn makes everyone's path look like a straight line, but in reality, it's a messy maze.
- The resilience required: Acknowledge that hearing "no" is exhausting, but it's just data. It's not a verdict on their worth as a human or a professional.
- A moment of genuine connection: "Between you and me, none of these corporate metrics measure the things that actually matterâ€”your curiosity, your grit, or your kindness."
- Encourage them to keep building, keep pushing, because the right door will open.

PARAGRAPH 3: BACK TO BUSINESS.
Snap back to the dry corporate tone immediately, as if the honest moment never happened. "We wish you the best in your future endeavors."

Sign off with a REALISTIC, INVENTED human name (e.g., 'Sarah Jenkins', 'David Cohen', 'Emma Thompson') and a title like 'Talent Acquisition Lead'. 
Do NOT use placeholders."""

        # Using Haiku (Stable)
        message = client.messages.create(
            model="claude-3-haiku-20240307",
            max_tokens=1024,
            messages=[{
                "role": "user",
                "content": prompt
            }]
        )
        
        rejection_text = message.content[0].text
        
        email_sent = False
        if email:
            email_sent, _ = send_rejection_email(email, rejection_text, company, role)
        
        return jsonify({
            'success': True,
            'rejection_letter': rejection_text,
            'count': new_count,
            'company': company,
            'role': role,
            'email_sent': email_sent
        })
        
    except Exception as e:
        print(f"CRITICAL ERROR: {str(e)}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/health', methods=['GET'])
def health():
    return jsonify({'status': 'healthy'})

if __name__ == '__main__':
    app.run(debug=True, port=5000)
